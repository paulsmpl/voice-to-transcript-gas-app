pipeline {
  agent any

  tools {
    git 'Default'
  }

  parameters {
    file(name: 'upload', description: 'Audio file upload (via iOS Shortcut)')
  }

  options {
    timeout(time: 20, unit: 'MINUTES')
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  environment {
    TMP_AUDIO = '/tmp/input_audio.m4a'
  }

  stages {
    stage('Capture upload') {
      steps {
        withFileParameter('upload') {
          echo "✅ Received uploaded file: $upload"
          sh '''
            mkdir -p /tmp
            cp "$upload" "$TMP_AUDIO"
            echo "Copied to $TMP_AUDIO"
          '''
        }
      }
    }

    stage('Checkout SCM') {
      steps {
        deleteDir()
        checkout scm
      }
    }

    stage('Prepare input') {
      steps {
        sh '''
          mkdir -p input
          cp "$TMP_AUDIO" input/input.m4a
        '''
      }
    }

    stage('Install deps + venv') {
      steps {
        sh '''
          set -eux
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
        '''
      }
    }

    stage('Run Python processing') {
      steps {
        sh '''
          set -eux
          . venv/bin/activate
          python process_audio_and_upload.py input/input.m4a
        '''
      }
    }
  }

  post {
    always {
      sh 'rm -rf input venv "$TMP_AUDIO" || true'
    }
    success {
      echo '✅ Audio processed and uploaded to GAS successfully.'
    }
    failure {
      echo '❌ Job failed. Check logs above.'
    }
  }
}
