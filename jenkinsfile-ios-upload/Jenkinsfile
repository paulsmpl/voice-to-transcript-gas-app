pipeline {
  agent any

  parameters {
    file(name: 'upload', description: 'Audio file upload (via iOS Shortcut)')
  }

  options {
    timeout(time: 20, unit: 'MINUTES')
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  stages {
    stage('Capture upload') {
      steps {
        script {
          def original = params.upload
          echo "Upload filename: ${original}"
          if (!fileExists(original)) {
            error "‚ùå Upload file '${original}' not found in workspace."
          }
          sh "cp '${original}' /tmp/input_audio.m4a"
        }
      }
    }

    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Prepare') {
      steps {
        sh """
          mkdir -p input
          cp /tmp/input_audio.m4a input/input.m4a
        """
      }
    }

    stage('Install deps + venv') {
      steps {
        sh '''
          set -eux
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
        '''
      }
    }

    stage('Run Python processing') {
      steps {
        sh '''
          set -eux
          . venv/bin/activate
          python process_audio_and_upload.py input/input.m4a
        '''
      }
    }
  }

  post {
    always {
      sh 'rm -rf input venv /tmp/input_audio.m4a || true'
    }
  }
}
